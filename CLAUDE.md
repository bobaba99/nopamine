# CLAUDE.md — Project Intelligence

## 1. Project Overview

TruePick is an AI-powered purchase decision tool that helps users avoid unnecessary spending. Users enter purchase details and receive a verdict (buy / hold / skip) generated by GPT-5-nano. Registered users can import email receipts (Gmail, Outlook), swipe on past purchases for regret/satisfaction tracking, and view aggregated spending patterns. The app is a TypeScript monorepo (`apps/web`, `apps/api`, `apps/mobile`, `packages/shared`) backed by Supabase.

---

## 2. Key Commands

```bash
# Development
npm run dev           # Start API + web dev servers concurrently
npm run dev:web       # Start web dev server only (Vite)
npm run dev:api       # Start API dev server only (Express + tsx watch)
npm run dev:mobile    # Start mobile dev server (Expo)

# Build
npm run build:web     # TypeScript check + Vite production build
npm run build:api     # Build API

# Code Quality
npm --workspace apps/web run lint   # ESLint check (web)

# Database
supabase start        # Start local Supabase (Postgres, Auth, Studio)
supabase db reset     # Reset DB with migrations + seed
supabase migration new <name>  # Create a new migration file
```

---

## 3. Architecture Summary

- **Monorepo** with npm workspaces: `apps/web` (React + Vite), `apps/api` (Express scaffold), `apps/mobile` (Expo scaffold), `packages/shared` (scaffold).
- **Supabase-first backend**: Auth, Postgres, RLS, and RPC functions are the primary backend. `apps/api` only has a `/health` endpoint.
- **Frontend calls Supabase directly** via `@supabase/supabase-js` for all CRUD, auth, and RPC operations.
- **OpenAI calls from browser** via native `fetch` for verdict evaluation and embeddings, and via `openai` SDK for receipt parsing. Keys are exposed via `VITE_` env vars (known security gap — move to Edge Functions before production).
- **Email import** uses Gmail REST API and Microsoft Graph API with OAuth, then GPT-5-nano for receipt extraction.

---

## 4. Important Patterns & Conventions

- **Component Pattern:** Functional components with hooks only. Page components own data fetching; reusable UI primitives in `components/Kinematics.tsx`.
- **API Pattern:** Service modules in `apps/web/src/api/` organized by domain (`purchase/`, `verdict/`, `email/`, `user/`, `resource/`). Reads throw on error; mutations return `{ error: string | null }`.
- **Error Handling:** Inline `.status` banners (`error` / `success` / `info`). Never expose DB table names to users. Keep messages under ~120 chars.
- **State Management:** React built-ins only (`useState`, `useEffect`, `useMemo`, `useCallback`, `useRef`). Supabase is the remote source of truth.
- **File Naming:** Components `PascalCase.tsx`, services `camelCase.ts`, CSS classes `kebab-case`, DB columns `snake_case`.
- **Styling:** Plain CSS with glassmorphism theme. Two global files: `index.css` (reset/tokens) and `App.css` (layout/components). No Tailwind or CSS-in-JS.
- **Immutability:** Always create new objects/arrays; never mutate state directly.

---

## 5. Critical Files & Directories

| Path | Purpose |
|------|---------|
| `apps/web/src/App.tsx` | Root component, routing, auth guards (`RequireAuth`, `PublicOnly`), `sessionLoading` state |
| `apps/web/src/api/verdict/` | Verdict service: LLM calls, prompt construction, scoring, validation |
| `apps/web/src/api/email/` | Gmail + Outlook import pipeline: OAuth, receipt parsing, dedup |
| `apps/web/src/api/purchase/` | Purchase CRUD, swipe service, stats aggregation |
| `apps/web/src/components/Kinematics.tsx` | GSAP-powered UI primitives: `LiquidButton`, `GlassCard`, `VolumetricInput`, `SplitText` |
| `apps/web/src/pages/` | Route-level pages: Dashboard, Swipe, Profile, Auth, Resources, AdminResources |
| `apps/web/src/styles/App.css` | All component styles, keyframes, responsive breakpoints |
| `supabase/migrations/` | Schema, RLS policies, functions, triggers (modular `_01` through `_06` files) |
| `supabase/config.toml` | Supabase local config |
| `DEBT.md` | Random non-priority features and fixes I encountered or brainstormed while working on other branches |
| `progress.md` | Progress on the current product feature implementations |

---

## 6. Known Gotchas & Pitfalls

- **Touch events**: Mobile swipe uses native `addEventListener('touchmove', fn, { passive: false })` via `useEffect`. React synthetic `onTouchMove` is passive and silently ignores `preventDefault()`. Use `useRef` for mutable state in native listeners to avoid stale closures.
- **Session hydration**: `sessionLoading` state must block all route rendering until `getSession()` resolves, otherwise `RequireAuth` redirects to `/auth` before the session loads.
- **GSAP CDN**: Loaded asynchronously at runtime in `Kinematics.tsx`. Components that depend on GSAP must handle the case where it hasn't loaded yet.
- **OpenAI key in browser**: `VITE_OPENAI_API_KEY` is exposed client-side. Acceptable for dev/MVP but must move to server/Edge Functions before production.
- **RLS policies**: Every user data table has RLS enabled. Mutations must include `user_id` ownership checks in both `USING` and `WITH CHECK`.
- **Migration ordering**: Modular migrations (`_01` through `_06`) must run in order. The `initial_schema.sql` and first `vendor_data.sql` are compatibility shims — do not edit them.

---

## 7. Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `VITE_SUPABASE_URL` | Yes | Supabase project URL |
| `VITE_SUPABASE_ANON_KEY` | Yes | Supabase anonymous/public key |
| `VITE_OPENAI_API_KEY` | Yes | OpenAI API key (verdict + embeddings + receipt parsing) |
| `VITE_GOOGLE_CLIENT_ID` | For Gmail import | Google OAuth client ID |
| `VITE_MICROSOFT_CLIENT_ID` | For Outlook import | Microsoft OAuth client ID |

---

## 8. Current Focus / Active Work

See `progress.md` for full task list. Key active items:
- Profile and history UX polish
- Settings route (language, theme, currency, verdict tone)
- Verdict sharing capability
- Alternative solution branching (budget vs. emotional)
- User data deletion (GDPR)

---

## 9. Do's and Don'ts

### Do
- If the action requires creating a new sql script for supabase, it must be done through `supabase migration new [migration-name]` to keep everything documented.
- Use immutable patterns — always spread or create new objects/arrays instead of mutating.
- Keep service modules organized by domain under `apps/web/src/api/`.
- Validate at boundaries: client form checks for UX, DB constraints and RPC guards for correctness.
- Use `sessionLoading` to prevent premature auth redirects.
- Keep error messages under ~120 chars and never expose internal schema names.

### Don't
- Don't use class components, external state libraries, or CSS-in-JS.
- Don't bypass RLS with `service_role` key in browser code.
- Don't edit the compatibility shim migrations (`initial_schema.sql`, first `vendor_data.sql`).
- Don't add `console.log` statements in committed code.
- Don't use React synthetic touch events for swipe gestures — use native listeners.
